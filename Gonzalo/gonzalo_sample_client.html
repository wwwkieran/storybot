<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exquisite Corpse Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #messages {
      width: 80%;
      height: 300px;
      border: 1px solid #ccc;
      overflow-y: scroll;
      padding: 10px;
      margin-bottom: 10px;
    }
    #inputSection {
      display: none;
    }
    #lastWords {
      font-weight: bold;
    }
    #error {
      color: red;
    }
    #players {
      margin-bottom: 10px;
    }
    #guessSection {
      display: none;
    }
    .sentence-option {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>Exquisite Corpse Game</h1>
  <div id="players">Connected Players: <span id="playerList"></span></div>
  <div id="messages"></div>

  <div id="joinSection">
    <input type="text" id="nameInput" placeholder="Enter your name">
    <button id="joinButton">Join Game</button>
  </div>

  <div id="startSection" style="display: none;">
    <button id="startButton">Start Game</button>
  </div>

  <div id="inputSection">
    <p id="turnMessage"></p>
    <p>Last Words: <span id="lastWords"></span></p>
    <textarea id="textInput" rows="4" cols="50" placeholder="Write your text here (min 2 sentences, max 40 words)"></textarea><br>
    <button id="submitButton">Submit</button>
    <p id="error"></p>
  </div>

  <div id="guessSection">
    <p>Guess which sentence was written by the AI:</p>
    <div id="sentenceOptions"></div>
    <button id="guessButton">Submit Guess</button>
    <p id="guessResult"></p>
    <button id="restartButton" style="display: none;">Restart Game</button>
  </div>

  <script>
    let ws;
    let playerId;
    let playerName;
    let isMyTurn = false;
    let sentences = [];
    let selectedSentenceIndex = null;

    function updatePlayerList(players) {
      document.getElementById('playerList').innerText = players.join(', ');
    }

    function appendMessage(message) {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML += message + '<br>';
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.getElementById('joinButton').addEventListener('click', () => {
      playerName = document.getElementById('nameInput').value.trim();
      if (playerName === '') {
        alert('Please enter your name.');
        return;
      }
      playerId = 'player-' + Math.random().toString(36).substr(2, 9);
      ws = new WebSocket('ws://localhost:8081');

      ws.onopen = () => {
        ws.send(JSON.stringify({
          type: 'UserJoined',
          id: playerId,
          name: playerName
        }));
        document.getElementById('joinSection').style.display = 'none';
        document.getElementById('startSection').style.display = 'block';
      };

      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        handleServerMessage(message);
      };

      ws.onclose = () => {
        appendMessage('Disconnected from the server.');
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    });

    document.getElementById('startButton').addEventListener('click', () => {
      ws.send(JSON.stringify({
        type: 'TriggerStart',
        id: playerId
      }));
      document.getElementById('startSection').style.display = 'none';
    });

    document.getElementById('submitButton').addEventListener('click', () => {
      const text = document.getElementById('textInput').value.trim();
      if (text === '') {
        document.getElementById('error').innerText = 'Please enter some text.';
        return;
      }
      // Check word count
      const wordCount = text.split(/\s+/).length;
      if (wordCount > 40) {
        document.getElementById('error').innerText = 'Your submission exceeds the maximum of 40 words.';
        return;
      }
      // Check sentence count
      const sentenceCount = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
      if (sentenceCount < 2) {
        document.getElementById('error').innerText = 'Your submission must contain at least 2 sentences.';
        return;
      }
      ws.send(JSON.stringify({
        type: 'UserSubmitted',
        id: playerId,
        text: text
      }));
      isMyTurn = false;
      document.getElementById('inputSection').style.display = 'none';
      document.getElementById('error').innerText = '';
      document.getElementById('textInput').value = '';
    });

    document.getElementById('guessButton').addEventListener('click', () => {
      if (selectedSentenceIndex === null) {
        alert('Please select a sentence.');
        return;
      }
      ws.send(JSON.stringify({
        type: 'GuessAI',
        id: playerId,
        selectedIndex: selectedSentenceIndex
      }));
      document.getElementById('guessSection').style.display = 'none';
      selectedSentenceIndex = null;
    });

    document.getElementById('restartButton').addEventListener('click', () => {
      // Reload the page to reset the game
      location.reload();
    });

    function handleServerMessage(message) {
      switch (message.type) {
        case 'Welcome':
          appendMessage(message.message);
          break;
        case 'UserJoined':
          appendMessage(`${message.name} has joined the game.`);
          // Update player list (optional)
          break;
        case 'UserLeft':
          appendMessage(message.message);
          // Update player list (optional)
          break;
        case 'GameStart':
          // Clear the messages div
          document.getElementById('messages').innerHTML = '';
          appendMessage(message.message);
          // Hide the connected players list
          document.getElementById('players').style.display = 'none';
          break;
        case 'YourTurn':
          isMyTurn = true;
          document.getElementById('inputSection').style.display = 'block';
          document.getElementById('turnMessage').innerText = message.message;
          document.getElementById('lastWords').innerText = message.lastWords || 'N/A';
          break;
        case 'UserSubmitted':
          // Optionally display submission messages
          break;
        case 'GuessAI':
          sentences = message.sentences;
          displaySentenceOptions();
          break;
        case 'GuessResult':
          appendMessage(message.message);
          // Show the restart button
          document.getElementById('restartButton').style.display = 'block';
          break;
        case 'GameEnded':
          // Clear the messages div
          document.getElementById('messages').innerHTML = '';
          appendMessage(message.message);
          appendMessage(message.completeText);
          break;
        case 'Error':
          document.getElementById('error').innerText = message.message;
          break;
        default:
          console.log('Unknown message type:', message.type);
      }
    }

    function displaySentenceOptions() {
      document.getElementById('guessSection').style.display = 'block';
      const sentenceOptionsDiv = document.getElementById('sentenceOptions');
      sentenceOptionsDiv.innerHTML = '';
      selectedSentenceIndex = null;

      sentences.forEach((sentence, index) => {
        const option = document.createElement('div');
        option.className = 'sentence-option';

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'sentence';
        radio.value = sentence.index;
        radio.id = 'sentence-' + index;

        radio.addEventListener('change', () => {
          selectedSentenceIndex = sentence.index;
        });

        const label = document.createElement('label');
        label.htmlFor = 'sentence-' + index;
        label.innerText = (sentence.index + 1).toString(); // Only show the number

        option.appendChild(radio);
        option.appendChild(label);

        sentenceOptionsDiv.appendChild(option);
      });
    }
  </script>
</body>
</html>